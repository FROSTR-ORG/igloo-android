<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIP-55 External App Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #2c3e50; margin-bottom: 10px; }
        .subtitle { color: #7f8c8d; margin-bottom: 30px; }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        .test-section h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 10px 5px 0;
            font-size: 14px;
            transition: background 0.2s;
        }
        button:hover { background: #2980b9; }
        button.danger { background: #e74c3c; }
        button.danger:hover { background: #c0392b; }
        .url-display {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            word-break: break-all;
            max-height: 120px;
            overflow-y: auto;
        }
        .result {
            background: #d5f4e6;
            border: 1px solid #27ae60;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .result h3 { margin-top: 0; color: #27ae60; }
        .result pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .instructions {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .config {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê NIP-55 External App Test</h1>
        <p class="subtitle">Simulate external applications triggering your PWA signer</p>

        <div class="config">
            <strong>PWA URL:</strong>
            <input type="text" id="pwaUrl" value="http://localhost:3000" style="width: 200px; padding: 5px; margin-left: 10px;">
            <button onclick="updatePwaUrl()" style="padding: 5px 10px; margin-left: 5px;">Update</button>
            <a href="http://localhost:3000" target="_blank" style="margin-left: 10px; color: #3498db; text-decoration: none;">üîó Open PWA</a>
        </div>

        <div class="config" style="background: #e8f5e8; border: 1px solid #27ae60;">
            <strong>üîß Protocol Handler Setup:</strong>
            <p style="margin: 5px 0; font-size: 14px; color: #2c3e50;">
                For NIP-55 URLs to work, the protocol handler must be registered from your PWA (not this test page).
            </p>
            <div style="margin: 10px 0;">
                <button onclick="openPwaForRegistration()" style="background: #27ae60; margin-right: 10px;">
                    1Ô∏è‚É£ Open PWA to Register Protocol
                </button>
                <button onclick="testRegistration()" style="background: #f39c12;">
                    2Ô∏è‚É£ Test if Registration Works
                </button>
                <button onclick="checkCurrentRegistration()" style="background: #8e44ad;">
                    üîç Check Current Registration
                </button>
                <button onclick="showRegistrationHelp()" style="background: #9b59b6;">
                    ‚ùì Show Manual Steps
                </button>
            </div>
            <div id="registrationStatus" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; display: none;"></div>
        </div>

        <div class="instructions">
            <strong>üìã Quick Start Instructions:</strong>
            <ol>
                <li><strong>Start your PWA:</strong> Make sure it's running at the URL configured above</li>
                <li><strong>Register protocol:</strong> Click "1Ô∏è‚É£ Open PWA to Register Protocol" (do this once)</li>
                <li><strong>Test registration:</strong> Click "2Ô∏è‚É£ Test if Registration Works"</li>
                <li><strong>Run tests:</strong> Use any test buttons below</li>
                <li><strong>View results:</strong> Results appear on this page or in your PWA</li>
            </ol>
            <p style="color: #e67e22; font-size: 14px; margin-top: 10px;">
                <strong>‚ö†Ô∏è Important:</strong> The protocol must be registered from your PWA (localhost:3000), not from this test page!
            </p>
        </div>

        <div class="test-section">
            <h3>üîë Basic Actions</h3>
            <button onclick="testGetPublicKey()">Get Public Key</button>
            <button onclick="testGetPublicKeyNoCallback()">Get Public Key (No Callback)</button>
            <div id="getPubkeyUrl" class="url-display"></div>
        </div>

        <div class="test-section">
            <h3>üìù Event Signing</h3>
            <button onclick="testSignNote()">Sign Text Note</button>
            <button onclick="testSignNoteNoCallback()">Sign Note (No Callback)</button>
            <button onclick="testSignProfile()" class="danger">‚ö†Ô∏è Sign Profile (High Risk)</button>
            <div id="signEventUrl" class="url-display"></div>
        </div>

        <div class="test-section">
            <h3>üîí Encryption/Decryption</h3>
            <button onclick="testNip04Encrypt()">NIP-04 Encrypt</button>
            <button onclick="testNip44Encrypt()">NIP-44 Encrypt</button>
            <button onclick="testNip04Decrypt()">NIP-04 Decrypt</button>
            <div id="encryptUrl" class="url-display"></div>
        </div>

        <div class="test-section">
            <h3>üß™ Advanced Tests</h3>
            <button onclick="testCustomEvent()">Custom Event Kind</button>
            <button onclick="testLongContent()">Long Content Event</button>
            <button onclick="testMultipleTags()">Event with Many Tags</button>
            <div id="advancedUrl" class="url-display"></div>
        </div>

        <div id="result"></div>
    </div>

    <script>
        let SIGNER_ORIGIN = 'http://localhost:3000'

        function updatePwaUrl() {
            SIGNER_ORIGIN = document.getElementById('pwaUrl').value
            console.log('Updated PWA URL to:', SIGNER_ORIGIN)
            // Update the PWA link
            document.querySelector('a[target="_blank"]').href = SIGNER_ORIGIN
        }

        function openPwaForRegistration() {
            const statusDiv = document.getElementById('registrationStatus')
            statusDiv.style.display = 'block'
            statusDiv.innerHTML = `
                <p><strong>üìñ Step-by-step:</strong></p>
                <ol style="margin: 5px 0; padding-left: 20px;">
                    <li>Click the <strong>"üîó Open PWA"</strong> link above (opens in new tab)</li>
                    <li>In the PWA tab, open browser console (F12)</li>
                    <li>Run this command in the console:</li>
                </ol>
                <pre style="background: #2c3e50; color: #ecf0f1; padding: 10px; border-radius: 4px; font-size: 11px; margin: 10px 0; overflow-x: auto;">navigator.registerProtocolHandler('web+nostrsigner', '${SIGNER_ORIGIN}/?nip55=%s', 'Igloo PWA Signer')</pre>
                <ol start="4" style="margin: 5px 0; padding-left: 20px;">
                    <li>Click "Allow" when browser asks for permission</li>
                    <li>Come back to this page and click "2Ô∏è‚É£ Test if Registration Works"</li>
                </ol>
                <button onclick="copyRegistrationCommand()" style="background: #3498db; padding: 5px 10px; margin-top: 5px;">üìã Copy Registration Command</button>
            `
            // Open PWA in new tab
            window.open(SIGNER_ORIGIN, '_blank')
        }

        function copyRegistrationCommand() {
            const command = `navigator.registerProtocolHandler('web+nostrsigner', '${SIGNER_ORIGIN}/?nip55=%s', 'Igloo PWA Signer')`
            navigator.clipboard.writeText(command).then(() => {
                alert('Registration command copied to clipboard! Paste it in your PWA console.')
            }).catch(() => {
                prompt('Copy this command and paste it in your PWA console:', command)
            })
        }

        function testRegistration() {
            const statusDiv = document.getElementById('registrationStatus')
            statusDiv.style.display = 'block'
            statusDiv.innerHTML = `
                <p><strong>üß™ Testing registration...</strong></p>
                <p>Attempting to open: <code>nostrsigner:?type=get_public_key</code></p>
                <p><em>If registration worked, this should open your PWA at ${SIGNER_ORIGIN}</em></p>
                <div style="margin-top: 10px;">
                    <button onclick="hideRegistrationStatus()" style="background: #95a5a6;">Close</button>
                </div>
            `

            // Test the protocol handler
            setTimeout(() => {
                window.location.href = 'nostrsigner:?type=get_public_key&test=registration'
            }, 1000)
        }

        function showRegistrationHelp() {
            const statusDiv = document.getElementById('registrationStatus')
            statusDiv.style.display = 'block'
            statusDiv.innerHTML = `
                <p><strong>üîß Manual Protocol Handler Registration:</strong></p>

                <p><strong>Chrome/Edge:</strong></p>
                <ol style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                    <li>Go to <code>chrome://settings/content/protocolHandlers</code></li>
                    <li>Remove any existing <code>web+nostrsigner</code> entries</li>
                    <li>Register from your PWA using the console command above</li>
                </ol>

                <p><strong>Firefox:</strong></p>
                <ol style="margin: 5px 0; padding-left: 20px; font-size: 13px;">
                    <li>Go to <code>about:preferences#general</code></li>
                    <li>Scroll to "Applications" section</li>
                    <li>Look for <code>web+nostrsigner</code> entries and remove incorrect ones</li>
                </ol>

                <p><strong>Alternative Testing (bypasses protocol handler):</strong></p>
                <p>Navigate directly to: <br>
                <code style="font-size: 11px;">${SIGNER_ORIGIN}/?nip55=%3Ftype%3Dget_public_key</code></p>

                <div style="margin-top: 10px;">
                    <button onclick="testDirectUrl()" style="background: #e67e22; margin-right: 10px;">üîó Test Direct URL</button>
                    <button onclick="hideRegistrationStatus()" style="background: #95a5a6;">Close</button>
                </div>
            `
        }

        function testDirectUrl() {
            const directUrl = `${SIGNER_ORIGIN}/?nip55=%3Ftype%3Dget_public_key%26test%3Ddirect`
            window.open(directUrl, '_blank')
        }

        function hideRegistrationStatus() {
            document.getElementById('registrationStatus').style.display = 'none'
        }

        function checkCurrentRegistration() {
            const statusDiv = document.getElementById('registrationStatus')
            statusDiv.style.display = 'block'
            statusDiv.innerHTML = `
                <p><strong>üîç Protocol Handler Status:</strong></p>
                <p>The <code>nostrsigner:</code> protocol is currently registered to open:</p>
                <p style="background: #ffe6e6; padding: 10px; border-radius: 4px; color: #c0392b;">
                    <strong>‚ùå Current:</strong> This test page (127.0.0.1:5500) - WRONG!
                </p>
                <p style="background: #e6ffe6; padding: 10px; border-radius: 4px; color: #27ae60;">
                    <strong>‚úÖ Should be:</strong> Your installed PWA
                </p>

                <p><strong>üîß How to fix the registration:</strong></p>
                <ol style="margin: 10px 0; padding-left: 20px; font-size: 14px;">
                    <li><strong>Clear wrong registration in Brave:</strong>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            <li>Go to <code>brave://settings/content/protocolHandlers</code></li>
                            <li>Remove any <code>web+nostrsigner</code> entries</li>
                        </ul>
                    </li>
                    <li><strong>Register from your PWA:</strong>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            <li>Open your installed PWA (from desktop/app menu)</li>
                            <li>Open DevTools (F12) in the PWA</li>
                            <li>Run: <code>navigator.registerProtocolHandler('web+nostrsigner', '${SIGNER_ORIGIN}/?nip55=%s', 'Igloo PWA Signer')</code></li>
                            <li>Click "Allow" when prompted</li>
                        </ul>
                    </li>
                </ol>

                <div style="margin-top: 15px;">
                    <button onclick="openBraveSettings()" style="background: #e74c3c; margin-right: 10px;">üîß Open Brave Settings</button>
                    <button onclick="testProtocolAfterFix()" style="background: #27ae60; margin-right: 10px;">üß™ Test nostrsigner: Protocol</button>
                    <button onclick="hideRegistrationStatus()" style="background: #95a5a6;">Close</button>
                </div>
            `
        }

        function openBraveSettings() {
            // Try to open Brave protocol handler settings
            window.open('brave://settings/content/protocolHandlers', '_blank')
        }

        function testProtocolAfterFix() {
            const statusDiv = document.getElementById('registrationStatus')
            statusDiv.innerHTML = `
                <p><strong>üß™ Testing nostrsigner: protocol with xdg-open...</strong></p>
                <p>Run these commands in your terminal to test the protocol:</p>

                <div style="margin: 15px 0;">
                    <div style="margin: 10px 0;">
                        <strong>üìù Get Public Key:</strong>
                        <button onclick="copyXdgCommand('get_public_key')" style="background: #27ae60; margin-left: 10px; padding: 5px 10px;">üìã Copy Command</button>
                        <pre id="xdg-get-public-key" style="background: #2c3e50; color: #ecf0f1; padding: 8px; border-radius: 4px; font-size: 11px; margin: 5px 0; overflow-x: auto;"></pre>
                    </div>

                    <div style="margin: 10px 0;">
                        <strong>‚úèÔ∏è Sign Event:</strong>
                        <button onclick="copyXdgCommand('sign_event')" style="background: #e67e22; margin-left: 10px; padding: 5px 10px;">üìã Copy Command</button>
                        <pre id="xdg-sign-event" style="background: #2c3e50; color: #ecf0f1; padding: 8px; border-radius: 4px; font-size: 11px; margin: 5px 0; overflow-x: auto;"></pre>
                    </div>

                    <div style="margin: 10px 0;">
                        <strong>üîí Encrypt:</strong>
                        <button onclick="copyXdgCommand('encrypt')" style="background: #9b59b6; margin-left: 10px; padding: 5px 10px;">üìã Copy Command</button>
                        <pre id="xdg-encrypt" style="background: #2c3e50; color: #ecf0f1; padding: 8px; border-radius: 4px; font-size: 11px; margin: 5px 0; overflow-x: auto;"></pre>
                    </div>
                </div>

                <p style="font-size: 12px; color: #7f8c8d;">
                    These <code>xdg-open</code> commands use the proper <code>nostrsigner:</code> protocol and should open your PWA correctly regardless of browser registration.
                </p>

                <button onclick="hideRegistrationStatus()" style="background: #95a5a6; margin-top: 10px;">Close</button>
            `

            // Generate the xdg-open commands
            generateXdgCommands()
        }

        function generateXdgCommands() {
            // Get Public Key command
            const getPubkeyUrl = `nostrsigner:?type=get_public_key&callbackUrl=${window.location.origin}/demo-result&test=xdg`
            document.getElementById('xdg-get-public-key').textContent = `xdg-open "${getPubkeyUrl}"`

            // Sign Event command
            const event = { kind: 1, content: 'Test from xdg-open with nostrsigner protocol!', tags: [['t', 'xdg-test']] }
            const eventJson = JSON.stringify(event)
            const signEventUrl = `nostrsigner:${encodeURIComponent(eventJson)}?type=sign_event&callbackUrl=${window.location.origin}/demo-result&test=xdg`
            document.getElementById('xdg-sign-event').textContent = `xdg-open "${signEventUrl}"`

            // Encrypt command
            const plaintext = 'Secret message via xdg-open!'
            const pubkey = '1234567890abcdef1234567890abcdef12345678901234567890abcdef1234567890'
            const encryptUrl = `nostrsigner:${encodeURIComponent(plaintext)}?type=nip04_encrypt&pubkey=${pubkey}&callbackUrl=${window.location.origin}/demo-result&test=xdg`
            document.getElementById('xdg-encrypt').textContent = `xdg-open "${encryptUrl}"`
        }

        function copyXdgCommand(type) {
            let cmd = ''
            switch(type) {
                case 'get_public_key':
                    cmd = document.getElementById('xdg-get-public-key').textContent
                    break
                case 'sign_event':
                    cmd = document.getElementById('xdg-sign-event').textContent
                    break
                case 'encrypt':
                    cmd = document.getElementById('xdg-encrypt').textContent
                    break
            }

            navigator.clipboard.writeText(cmd).then(() => {
                alert(`Command copied! Run this in your terminal:\n\n${cmd}\n\nThis uses the nostrsigner: protocol and should open your PWA directly.`)
            }).catch(() => {
                prompt('Copy this command and run it in your terminal:', cmd)
            })
        }

        function testNostrsignerProtocol() {
            window.location.href = 'nostrsigner:?type=get_public_key&test=protocol&callbackUrl=' + window.location.origin + '/demo-result'
        }

        function openBrowserSettings() {
            alert('Opening browser protocol handler settings...')
            // Try to open browser settings (this may not work in all browsers)
            if (navigator.userAgent.includes('Chrome') || navigator.userAgent.includes('Edge')) {
                window.open('chrome://settings/content/protocolHandlers', '_blank')
            } else if (navigator.userAgent.includes('Firefox')) {
                window.open('about:preferences#general', '_blank')
            } else {
                alert('Please manually navigate to your browser settings and look for "Protocol Handlers" or "Applications"')
            }
        }

        function skipProtocolHandler() {
            const statusDiv = document.getElementById('registrationStatus')
            statusDiv.innerHTML = `
                <p><strong>üöÄ Direct Testing (No Protocol Handler Needed):</strong></p>
                <p>Since you have an installed PWA, run these commands in your terminal to open it directly:</p>

                <div style="margin: 15px 0;">
                    <div style="margin: 10px 0;">
                        <strong>üìù Get Public Key Test:</strong>
                        <button onclick="copyDirectCommand('get_public_key')" style="background: #27ae60; margin-left: 10px; padding: 5px 10px;">üìã Copy Command</button>
                        <pre id="cmd-get-public-key" style="background: #2c3e50; color: #ecf0f1; padding: 8px; border-radius: 4px; font-size: 11px; margin: 5px 0; overflow-x: auto;"></pre>
                    </div>

                    <div style="margin: 10px 0;">
                        <strong>‚úèÔ∏è Sign Event Test:</strong>
                        <button onclick="copyDirectCommand('sign_event')" style="background: #e67e22; margin-left: 10px; padding: 5px 10px;">üìã Copy Command</button>
                        <pre id="cmd-sign-event" style="background: #2c3e50; color: #ecf0f1; padding: 8px; border-radius: 4px; font-size: 11px; margin: 5px 0; overflow-x: auto;"></pre>
                    </div>

                    <div style="margin: 10px 0;">
                        <strong>üîí Encrypt Test:</strong>
                        <button onclick="copyDirectCommand('encrypt')" style="background: #9b59b6; margin-left: 10px; padding: 5px 10px;">üìã Copy Command</button>
                        <pre id="cmd-encrypt" style="background: #2c3e50; color: #ecf0f1; padding: 8px; border-radius: 4px; font-size: 11px; margin: 5px 0; overflow-x: auto;"></pre>
                    </div>
                </div>

                <p style="font-size: 12px; color: #7f8c8d;">
                    These commands will open your installed PWA directly and show the signing prompts.
                </p>

                <button onclick="hideRegistrationStatus()" style="background: #95a5a6; margin-top: 10px;">Close</button>
            `

            // Generate and show the commands
            generateDirectCommands()
        }

        function generateDirectCommands() {
            // Get Public Key command
            const getPubkeyUrl = `${SIGNER_ORIGIN}/?nip55=${encodeURIComponent('?type=get_public_key&callbackUrl=' + window.location.origin + '/demo-result')}`
            document.getElementById('cmd-get-public-key').textContent = `xdg-open "${getPubkeyUrl}"`

            // Sign Event command
            const event = { kind: 1, content: 'Direct test from external page!', tags: [['t', 'direct-test']] }
            const eventJson = JSON.stringify(event)
            const signEventParam = `${eventJson}?type=sign_event&callbackUrl=${window.location.origin}/demo-result`
            const signEventUrl = `${SIGNER_ORIGIN}/?nip55=${encodeURIComponent(signEventParam)}`
            document.getElementById('cmd-sign-event').textContent = `xdg-open "${signEventUrl}"`

            // Encrypt command
            const plaintext = 'Direct encryption test message!'
            const pubkey = '1234567890abcdef1234567890abcdef12345678901234567890abcdef1234567890'
            const encryptParam = `${plaintext}?type=nip04_encrypt&pubkey=${pubkey}&callbackUrl=${window.location.origin}/demo-result`
            const encryptUrl = `${SIGNER_ORIGIN}/?nip55=${encodeURIComponent(encryptParam)}`
            document.getElementById('cmd-encrypt').textContent = `xdg-open "${encryptUrl}"`
        }

        function copyDirectCommand(type) {
            let cmd = ''
            switch(type) {
                case 'get_public_key':
                    cmd = document.getElementById('cmd-get-public-key').textContent
                    break
                case 'sign_event':
                    cmd = document.getElementById('cmd-sign-event').textContent
                    break
                case 'encrypt':
                    cmd = document.getElementById('cmd-encrypt').textContent
                    break
            }

            navigator.clipboard.writeText(cmd).then(() => {
                alert(`Command copied! Paste and run in your terminal:\n\n${cmd}`)
            }).catch(() => {
                prompt('Copy this command and run it in your terminal:', cmd)
            })
        }

        // Direct testing functions (bypass protocol handler)
        function testDirectGetPublicKey() {
            const url = `${SIGNER_ORIGIN}/?nip55=${encodeURIComponent('?type=get_public_key&callbackUrl=' + window.location.origin + '/demo-result')}`

            // Try to open in installed PWA first, fallback to browser tab
            try {
                // This tries to use xdg-open on Linux to open the installed PWA
                if (window.location.protocol === 'file:' || window.location.hostname === '127.0.0.1') {
                    // We're likely in a local test file, suggest command line approach
                    alert(`Copy and run this command in your terminal:\nxdg-open "${url}"`)
                } else {
                    window.open(url, '_blank')
                }
            } catch (error) {
                window.open(url, '_blank')
            }
        }

        function testDirectSignEvent() {
            const event = { kind: 1, content: 'Direct test from external page!', tags: [['t', 'direct-test']] }
            const eventJson = JSON.stringify(event)
            const nip55Param = `${eventJson}?type=sign_event&callbackUrl=${window.location.origin}/demo-result`
            const url = `${SIGNER_ORIGIN}/?nip55=${encodeURIComponent(nip55Param)}`

            try {
                if (window.location.protocol === 'file:' || window.location.hostname === '127.0.0.1') {
                    alert(`Copy and run this command in your terminal:\nxdg-open "${url}"`)
                } else {
                    window.open(url, '_blank')
                }
            } catch (error) {
                window.open(url, '_blank')
            }
        }

        function testDirectEncrypt() {
            const plaintext = 'Direct encryption test message!'
            const pubkey = '1234567890abcdef1234567890abcdef12345678901234567890abcdef1234567890'
            const nip55Param = `${plaintext}?type=nip04_encrypt&pubkey=${pubkey}&callbackUrl=${window.location.origin}/demo-result`
            const url = `${SIGNER_ORIGIN}/?nip55=${encodeURIComponent(nip55Param)}`

            try {
                if (window.location.protocol === 'file:' || window.location.hostname === '127.0.0.1') {
                    alert(`Copy and run this command in your terminal:\nxdg-open "${url}"`)
                } else {
                    window.open(url, '_blank')
                }
            } catch (error) {
                window.open(url, '_blank')
            }
        }

        function showUrl(elementId, url) {
            document.getElementById(elementId).textContent = url
        }

        function testGetPublicKey() {
            const url = `nostrsigner:?type=get_public_key&callbackUrl=${SIGNER_ORIGIN}/demo-result`
            showUrl('getPubkeyUrl', url)
            window.location.href = url
        }

        function testGetPublicKeyNoCallback() {
            const url = `nostrsigner:?type=get_public_key`
            showUrl('getPubkeyUrl', url)
            window.location.href = url
        }

        function testSignNote() {
            const event = {
                kind: 1,
                content: 'Hello from external NIP-55 test! This is a test note.',
                tags: [
                    ['t', 'test'],
                    ['t', 'nip55'],
                    ['client', 'external-test-app']
                ]
            }
            const eventJson = encodeURIComponent(JSON.stringify(event))
            const url = `nostrsigner:${eventJson}?type=sign_event&callbackUrl=${SIGNER_ORIGIN}/demo-result&id=test-note-123`
            showUrl('signEventUrl', url)
            window.location.href = url
        }

        function testSignNoteNoCallback() {
            const event = {
                kind: 1,
                content: 'Test note without callback - result will be copied to clipboard.',
                tags: [['t', 'clipboard-test']]
            }
            const eventJson = encodeURIComponent(JSON.stringify(event))
            const url = `nostrsigner:${eventJson}?type=sign_event&id=clipboard-test-456`
            showUrl('signEventUrl', url)
            window.location.href = url
        }

        function testSignProfile() {
            const profileData = {
                name: 'Test Profile Name',
                about: 'This is a test profile update from the NIP-55 external test app.',
                picture: 'https://example.com/test-avatar.jpg',
                nip05: 'test@example.com'
            }
            const event = {
                kind: 0,
                content: JSON.stringify(profileData),
                tags: []
            }
            const eventJson = encodeURIComponent(JSON.stringify(event))
            const url = `nostrsigner:${eventJson}?type=sign_event&callbackUrl=${SIGNER_ORIGIN}/demo-result&id=profile-test-789`
            showUrl('signEventUrl', url)
            window.location.href = url
        }

        function testNip04Encrypt() {
            const plaintext = encodeURIComponent('üîí Secret message from external test app using NIP-04!')
            const pubkey = '1234567890abcdef1234567890abcdef12345678901234567890abcdef1234567890'
            const url = `nostrsigner:${plaintext}?type=nip04_encrypt&pubkey=${pubkey}&callbackUrl=${SIGNER_ORIGIN}/demo-result&id=encrypt-test-101`
            showUrl('encryptUrl', url)
            window.location.href = url
        }

        function testNip44Encrypt() {
            const plaintext = encodeURIComponent('üîê Secret message from external test app using NIP-44!')
            const pubkey = 'abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef'
            const url = `nostrsigner:${plaintext}?type=nip44_encrypt&pubkey=${pubkey}&callbackUrl=${SIGNER_ORIGIN}/demo-result&id=encrypt44-test-102`
            showUrl('encryptUrl', url)
            window.location.href = url
        }

        function testNip04Decrypt() {
            // This is fake encrypted data for testing
            const ciphertext = encodeURIComponent('U2FsdGVkX1+fake/encrypted/data/for+testing?iv=fakeinitializationvector')
            const pubkey = '1234567890abcdef1234567890abcdef12345678901234567890abcdef1234567890'
            const url = `nostrsigner:${ciphertext}?type=nip04_decrypt&pubkey=${pubkey}&callbackUrl=${SIGNER_ORIGIN}/demo-result&id=decrypt-test-103`
            showUrl('encryptUrl', url)
            window.location.href = url
        }

        function testCustomEvent() {
            const event = {
                kind: 30078,
                content: JSON.stringify({
                    app: 'external-test',
                    data: { test: true, timestamp: Date.now() }
                }),
                tags: [
                    ['d', 'test-data'],
                    ['k', '30078']
                ]
            }
            const eventJson = encodeURIComponent(JSON.stringify(event))
            const url = `nostrsigner:${eventJson}?type=sign_event&callbackUrl=${SIGNER_ORIGIN}/demo-result&id=custom-event-201`
            showUrl('advancedUrl', url)
            window.location.href = url
        }

        function testLongContent() {
            const longContent = 'Lorem ipsum dolor sit amet, consectetur adipiscing elit. '.repeat(50)
            const event = {
                kind: 30023,
                content: longContent,
                tags: [
                    ['title', 'Long Content Test'],
                    ['summary', 'Testing long content handling in NIP-55'],
                    ['t', 'test'],
                    ['t', 'long-content']
                ]
            }
            const eventJson = encodeURIComponent(JSON.stringify(event))
            const url = `nostrsigner:${eventJson}?type=sign_event&callbackUrl=${SIGNER_ORIGIN}/demo-result&id=long-content-202`
            showUrl('advancedUrl', url)
            window.location.href = url
        }

        function testMultipleTags() {
            const tags = []
            for (let i = 0; i < 20; i++) {
                tags.push(['t', `tag${i}`])
            }
            tags.push(['client', 'external-test-app'])
            tags.push(['title', 'Many Tags Test'])

            const event = {
                kind: 1,
                content: 'This event has many tags to test tag display truncation.',
                tags: tags
            }
            const eventJson = encodeURIComponent(JSON.stringify(event))
            const url = `nostrsigner:${eventJson}?type=sign_event&callbackUrl=${SIGNER_ORIGIN}/demo-result&id=many-tags-203`
            showUrl('advancedUrl', url)
            window.location.href = url
        }

        // Handle results from callback URLs
        window.onload = function() {
            const params = new URLSearchParams(window.location.search)
            const result = params.get('result')
            const event = params.get('event')
            const id = params.get('id')

            if (result) {
                document.getElementById('result').innerHTML = `
                    <div class="result">
                        <h3>‚úÖ Result Received!</h3>
                        ${id ? `<p><strong>Request ID:</strong> ${id}</p>` : ''}
                        <p><strong>Result:</strong></p>
                        <pre>${result}</pre>
                        ${event ? `<p><strong>Signed Event:</strong></p><pre>${JSON.stringify(JSON.parse(event), null, 2)}</pre>` : ''}
                        <button onclick="clearResult()">Clear Result</button>
                    </div>
                `
            }
        }

        function clearResult() {
            document.getElementById('result').innerHTML = ''
            // Clear URL parameters
            window.history.replaceState({}, document.title, window.location.pathname)
        }

        // Show current URL on load
        console.log('NIP-55 External Test App loaded')
        console.log('PWA URL:', SIGNER_ORIGIN)
        console.log('Test page URL:', window.location.href)
    </script>
</body>
</html>