<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polyfill Test Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background: #e8f5e8; color: #2e7d2e; }
        .error { background: #ffe8e8; color: #d32f2f; }
        .info { background: #e8f4fd; color: #1976d2; }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background: #1565c0; }
        .log {
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üß™ Secure Polyfill Test Suite</h1>
    <p>Testing WebSocket and Storage polyfills with secure Android bridges.</p>

    <!-- Storage Tests -->
    <div class="test-section">
        <h2>üóÑÔ∏è Storage Polyfill Tests</h2>
        <div id="storage-status" class="test-result info">Ready to test...</div>

        <button onclick="testLocalStorage()">Test localStorage</button>
        <button onclick="testSessionStorage()">Test sessionStorage</button>
        <button onclick="testStorageAPI()">Test Storage API Compatibility</button>
        <button onclick="testStorageEvents()">Test Storage Events</button>
        <button onclick="clearAllStorage()">Clear All Storage</button>

        <div id="storage-log" class="log"></div>
    </div>

    <!-- WebSocket Tests -->
    <div class="test-section">
        <h2>üîå WebSocket Polyfill Tests</h2>
        <div id="websocket-status" class="test-result info">Ready to test...</div>

        <button onclick="testWebSocketEcho()">Test Echo Server</button>
        <button onclick="testWebSocketAPI()">Test WebSocket API</button>
        <button onclick="testMultipleConnections()">Test Multiple Connections</button>

        <div id="websocket-log" class="log"></div>
    </div>

    <!-- Bridge Status -->
    <div class="test-section">
        <h2>üåâ Bridge Status</h2>
        <div id="bridge-status"></div>
    </div>

    <script>
        // Logging utilities
        function log(section, message, type = 'info') {
            const logElement = document.getElementById(section + '-log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${section}] ${message}`);
        }

        function setStatus(section, message, type = 'info') {
            const statusElement = document.getElementById(section + '-status');
            statusElement.textContent = message;
            statusElement.className = `test-result ${type}`;
        }

        // Storage Tests
        function testLocalStorage() {
            setStatus('storage', 'Testing localStorage...', 'info');
            log('storage', 'Starting localStorage test');

            try {
                // Test basic operations
                const testKey = 'test_key_' + Date.now();
                const testValue = 'test_value_' + Math.random();

                // Test setItem
                localStorage.setItem(testKey, testValue);
                log('storage', `‚úì setItem: ${testKey} = ${testValue}`);

                // Test getItem
                const retrieved = localStorage.getItem(testKey);
                if (retrieved === testValue) {
                    log('storage', `‚úì getItem: Retrieved correct value`);
                } else {
                    throw new Error(`getItem mismatch: expected ${testValue}, got ${retrieved}`);
                }

                // Test length
                const length = localStorage.length;
                log('storage', `‚úì length: ${length} items in localStorage`);

                // Test key()
                const keyAtIndex = localStorage.key(0);
                log('storage', `‚úì key(0): ${keyAtIndex}`);

                // Test removeItem
                localStorage.removeItem(testKey);
                const afterRemove = localStorage.getItem(testKey);
                if (afterRemove === null) {
                    log('storage', `‚úì removeItem: Item successfully removed`);
                } else {
                    throw new Error(`removeItem failed: item still exists`);
                }

                setStatus('storage', 'localStorage test passed!', 'success');

            } catch (error) {
                log('storage', `‚úó localStorage test failed: ${error.message}`, 'error');
                setStatus('storage', 'localStorage test failed!', 'error');
            }
        }

        function testSessionStorage() {
            setStatus('storage', 'Testing sessionStorage...', 'info');
            log('storage', 'Starting sessionStorage test');

            try {
                // Test basic operations
                const testKey = 'session_test_' + Date.now();
                const testValue = 'session_value_' + Math.random();

                sessionStorage.setItem(testKey, testValue);
                log('storage', `‚úì sessionStorage.setItem: ${testKey} = ${testValue}`);

                const retrieved = sessionStorage.getItem(testKey);
                if (retrieved === testValue) {
                    log('storage', `‚úì sessionStorage.getItem: Retrieved correct value`);
                } else {
                    throw new Error(`sessionStorage getItem mismatch`);
                }

                sessionStorage.removeItem(testKey);
                log('storage', `‚úì sessionStorage.removeItem: Item removed`);

                setStatus('storage', 'sessionStorage test passed!', 'success');

            } catch (error) {
                log('storage', `‚úó sessionStorage test failed: ${error.message}`, 'error');
                setStatus('storage', 'sessionStorage test failed!', 'error');
            }
        }

        function testStorageAPI() {
            log('storage', 'Testing Storage API compatibility');

            try {
                // Test that localStorage and sessionStorage exist
                if (typeof localStorage === 'undefined') {
                    throw new Error('localStorage is undefined');
                }
                if (typeof sessionStorage === 'undefined') {
                    throw new Error('sessionStorage is undefined');
                }

                log('storage', '‚úì localStorage and sessionStorage objects exist');

                // Test Storage interface methods
                const requiredMethods = ['getItem', 'setItem', 'removeItem', 'clear', 'key'];
                requiredMethods.forEach(method => {
                    if (typeof localStorage[method] !== 'function') {
                        throw new Error(`localStorage.${method} is not a function`);
                    }
                    if (typeof sessionStorage[method] !== 'function') {
                        throw new Error(`sessionStorage.${method} is not a function`);
                    }
                });

                log('storage', '‚úì All required Storage methods exist');

                // Test length property
                if (typeof localStorage.length !== 'number') {
                    throw new Error('localStorage.length is not a number');
                }

                log('storage', '‚úì Storage API compatibility test passed');

            } catch (error) {
                log('storage', `‚úó Storage API test failed: ${error.message}`, 'error');
            }
        }

        function testStorageEvents() {
            log('storage', 'Testing storage events');

            try {
                let eventReceived = false;
                const testKey = 'event_test_' + Date.now();
                const testValue = 'event_value';

                // Listen for storage event
                const eventHandler = (event) => {
                    log('storage', `‚úì Storage event received: key=${event.key}, newValue=${event.newValue}`);
                    eventReceived = true;
                };

                window.addEventListener('storage', eventHandler);

                // Trigger storage event
                localStorage.setItem(testKey, testValue);

                // Clean up
                setTimeout(() => {
                    window.removeEventListener('storage', eventHandler);
                    localStorage.removeItem(testKey);

                    if (eventReceived) {
                        log('storage', '‚úì Storage events working correctly');
                    } else {
                        log('storage', '‚ö† Storage event not received (may be normal in single-tab scenario)');
                    }
                }, 100);

            } catch (error) {
                log('storage', `‚úó Storage event test failed: ${error.message}`, 'error');
            }
        }

        function clearAllStorage() {
            try {
                localStorage.clear();
                sessionStorage.clear();
                log('storage', '‚úì All storage cleared');
                setStatus('storage', 'Storage cleared', 'success');
            } catch (error) {
                log('storage', `‚úó Clear storage failed: ${error.message}`, 'error');
            }
        }

        // WebSocket Tests
        function testWebSocketEcho() {
            setStatus('websocket', 'Testing WebSocket echo...', 'info');
            log('websocket', 'Starting WebSocket echo test');

            try {
                // Test with a public echo server
                const ws = new WebSocket('wss://echo.websocket.org');
                let testPassed = false;

                ws.onopen = function(event) {
                    log('websocket', '‚úì WebSocket connection opened');
                    ws.send('Hello from secure polyfill!');
                };

                ws.onmessage = function(event) {
                    log('websocket', `‚úì Received echo: ${event.data}`);
                    testPassed = true;
                    ws.close();
                };

                ws.onclose = function(event) {
                    log('websocket', `‚úì WebSocket connection closed (code: ${event.code})`);
                    if (testPassed) {
                        setStatus('websocket', 'WebSocket echo test passed!', 'success');
                    }
                };

                ws.onerror = function(event) {
                    log('websocket', `‚úó WebSocket error occurred`, 'error');
                    setStatus('websocket', 'WebSocket echo test failed!', 'error');
                };

                // Timeout after 10 seconds
                setTimeout(() => {
                    if (!testPassed) {
                        log('websocket', '‚úó WebSocket test timed out', 'error');
                        setStatus('websocket', 'WebSocket test timed out!', 'error');
                        ws.close();
                    }
                }, 10000);

            } catch (error) {
                log('websocket', `‚úó WebSocket test failed: ${error.message}`, 'error');
                setStatus('websocket', 'WebSocket test failed!', 'error');
            }
        }

        function testWebSocketAPI() {
            log('websocket', 'Testing WebSocket API compatibility');

            try {
                // Test that WebSocket constructor exists
                if (typeof WebSocket === 'undefined') {
                    throw new Error('WebSocket is undefined');
                }

                log('websocket', '‚úì WebSocket constructor exists');

                // Test WebSocket constants
                const constants = ['CONNECTING', 'OPEN', 'CLOSING', 'CLOSED'];
                constants.forEach(constant => {
                    if (typeof WebSocket[constant] !== 'number') {
                        throw new Error(`WebSocket.${constant} is not defined`);
                    }
                });

                log('websocket', '‚úì WebSocket constants defined');

                // Create a WebSocket instance
                const ws = new WebSocket('wss://echo.websocket.org');

                // Test instance properties
                if (typeof ws.readyState !== 'number') {
                    throw new Error('readyState is not a number');
                }
                if (typeof ws.url !== 'string') {
                    throw new Error('url is not a string');
                }

                log('websocket', '‚úì WebSocket instance properties correct');

                // Test instance methods
                const methods = ['send', 'close'];
                methods.forEach(method => {
                    if (typeof ws[method] !== 'function') {
                        throw new Error(`${method} is not a function`);
                    }
                });

                log('websocket', '‚úì WebSocket API compatibility test passed');

                ws.close();

            } catch (error) {
                log('websocket', `‚úó WebSocket API test failed: ${error.message}`, 'error');
            }
        }

        function testMultipleConnections() {
            log('websocket', 'Testing multiple WebSocket connections');

            try {
                const connections = [];
                const testCount = 3;
                let openCount = 0;

                for (let i = 0; i < testCount; i++) {
                    const ws = new WebSocket('wss://echo.websocket.org');
                    connections.push(ws);

                    ws.onopen = function() {
                        openCount++;
                        log('websocket', `‚úì Connection ${i + 1} opened (${openCount}/${testCount})`);

                        if (openCount === testCount) {
                            log('websocket', '‚úì All multiple connections opened successfully');

                            // Close all connections
                            connections.forEach((conn, index) => {
                                conn.close();
                                log('websocket', `‚úì Connection ${index + 1} closed`);
                            });
                        }
                    };

                    ws.onerror = function() {
                        log('websocket', `‚úó Connection ${i + 1} failed`, 'error');
                    };
                }

            } catch (error) {
                log('websocket', `‚úó Multiple connections test failed: ${error.message}`, 'error');
            }
        }

        // Bridge Status Check
        function checkBridgeStatus() {
            const bridgeStatus = document.getElementById('bridge-status');
            let status = '<h3>Bridge Availability:</h3>';

            // Check WebSocket bridge
            if (window.WebSocketBridge) {
                status += '<div class="test-result success">‚úì WebSocketBridge: Available</div>';
            } else {
                status += '<div class="test-result error">‚úó WebSocketBridge: Not Available</div>';
            }

            // Check Storage bridge
            if (window.SecureStorageBridge) {
                status += '<div class="test-result success">‚úì SecureStorageBridge: Available</div>';
            } else {
                status += '<div class="test-result error">‚úó SecureStorageBridge: Not Available</div>';
            }

            // Check polyfill status
            if (window.SecureStorage && window.SecureStorage.isActive()) {
                status += '<div class="test-result success">‚úì Storage Polyfill: Active</div>';
            } else {
                status += '<div class="test-result error">‚úó Storage Polyfill: Inactive</div>';
            }

            bridgeStatus.innerHTML = status;
        }

        // Initialize tests when page loads
        window.addEventListener('load', function() {
            console.log('Test page loaded - checking bridge status');
            checkBridgeStatus();

            // Test basic functionality
            setTimeout(() => {
                log('storage', 'Auto-running basic storage test...');
                testStorageAPI();

                log('websocket', 'Auto-running basic WebSocket test...');
                testWebSocketAPI();
            }, 1000);
        });

        // Error handling
        window.addEventListener('error', function(e) {
            console.error('Page error:', e.error);
            log('system', `Page error: ${e.message}`, 'error');
        });
    </script>
</body>
</html>